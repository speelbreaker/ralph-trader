# PR Postmortem (Agent-Filled)

## 0) What shipped
- Feature/behavior: Added durable WAL ledger module with bounded queue, replay helpers, and tests proving no-resend after crash.
- What value it has (what problem it solves, upgrade provides): Establishes RecordedBeforeDispatch with replay-safe intent reconstruction and hot-loop-safe WAL enqueue errors.
- Governing contract: specs/CONTRACT.md

## 1) Constraint (ONE)
- How it manifested (2-3 concrete symptoms): Needed durable append without new deps; queue-full behavior required non-blocking semantics; tests had to avoid hanging with a paused writer.
- Time/token drain it caused: Extra time designing a simple line format and writer pause/resume to keep tests deterministic.
- Workaround I used this PR (exploit): Implemented a lightweight key-value WAL format plus a paused writer flag for deterministic queue-full tests.
- Next-agent default behavior (subordinate): Reuse the existing ledger format and pause/resume hook for new WAL tests instead of adding new deps.
- Permanent fix proposal (elevate): Introduce a shared serialization helper crate once scope allows.
- Smallest increment: Add a serde_json dependency in soldier_infra and migrate ledger encode/decode to JSON lines.
- Validation (proof it got better): Simplified WAL parsing code and fewer custom parse tests; same replay tests pass.

## 2) Given what I built, what's the single best follow-up PR, and what 1-3 upgrades are worth considering next? Include smallest increment + how we validate.
- Response: Add ledger persistence tests for ack/fill replay (AT-233/AT-234 coverage). Smallest increment: add tests that append ack/fill records and assert replay_latest returns those states. Validate with `cargo test -p soldier_infra --test test_ledger_replay` and `./plans/verify.sh full`.

## 3) Given what I built and the pain I hit (top sinks + failure modes), what 1-3 enforceable AGENTS.md rules should we add so the next agent doesn't repeat it?
- Response: None.
