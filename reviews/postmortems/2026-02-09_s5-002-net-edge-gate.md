# PR Postmortem (Agent-Filled)

## 0) What shipped
- Feature/behavior: Net Edge gate evaluator with fail-closed input validation, rejection metrics, and unit tests for low-edge and missing-input paths.
- What value it has (what problem it solves, upgrade provides): Prevents OPEN dispatch when net edge after fees/slippage falls below min_edge_usd and blocks opens when edge inputs are missing or invalid.
- Governing contract: specs/CONTRACT.md

## 1) Constraint (ONE)
- How it manifested (2-3 concrete symptoms): Reject reason taxonomy is fragmented across gate modules; PRD expects RejectReason::NetEdge* while existing reject enums are per-gate; scope forbids touching dispatch-map types.
- Time/token drain it caused: Extra design passes to keep contract reason names aligned without cross-module churn.
- Workaround I used this PR (exploit): Introduced NetEdgeRejectReason scoped to the new gate and asserted contract-named variants in tests.
- Next-agent default behavior (subordinate): Keep reject reason enums per gate unless a unified registry exists; ensure variant names match contract tokens.
- Permanent fix proposal (elevate): Introduce a shared RejectReasonCode enum in core and migrate gate rejects to it.
- Smallest increment: Add a new enum under execution/ for RejectReasonCode and map existing gate rejects into it without changing gate behavior.
- Validation (proof it got better): Single RejectReasonCode used in NetEdge + Liquidity gates with tests asserting contract tokens.

## 2) Given what I built, what's the single best follow-up PR, and what 1-3 upgrades are worth considering next? Include smallest increment + how we validate.
- Response: Wire Net Edge gate into the build_order_intent chokepoint ordering (S5.5) and assert OPEN dispatch blocks when net edge fails. Smallest increment: add a gate-ordering test that logs net-edge evaluation before pricer; validate with `cargo test -p soldier_core --test test_gate_ordering`.

## 3) Given what I built and the pain I hit (top sinks + failure modes), what 1-3 enforceable AGENTS.md rules should we add so the next agent doesn't repeat it?
- Response: Add a rule to keep contract reject tokens consistent across gate enums and tests; add a rule to avoid expanding dispatch-map reject enums outside explicit scope.
