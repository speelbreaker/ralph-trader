# PR Postmortem (Agent-Filled)

## 0) What shipped
- Feature/behavior: Added recovery label matching with deterministic tie-breakers (ih16 → instrument → side → qty_q), ambiguity degradation, and ambiguity metric counter; added unit tests for tie-break order, ambiguity degrade, and deterministic single match.
- What value it has (what problem it solves, upgrade provides): Deterministic collision-safe label matching that fails closed on ambiguity and surfaces observability.
- Governing contract: specs/CONTRACT.md

## 1) Constraint (ONE)
- How it manifested (2-3 concrete symptoms): Needed to confirm exact tie-breaker ordering and ambiguity handling before implementing; no existing recovery module to reference.
- Time/token drain it caused: Extra contract reading and test design iterations to encode tie-breaker precedence explicitly.
- Workaround I used this PR (exploit): Implemented small, isolated recovery module with explicit ordering tests that prove precedence.
- Next-agent default behavior (subordinate): Read CONTRACT.md §1.1.2 before editing recovery/label matching; encode order in tests.
- Permanent fix proposal (elevate): Add a recovery module stub map in docs/codebase/structure.md with the label match entry point and contract refs.
- Smallest increment: Add a one-line recovery section to docs/codebase/structure.md naming soldier_core::recovery::label_match.
- Validation (proof it got better): Docs entry exists and references §1.1.2; no rework needed to locate match logic.

## 2) Given what I built, what's the single best follow-up PR, and what 1-3 upgrades are worth considering next? Include smallest increment + how we validate.
- Response: Wire label_match into the recovery pipeline once the reconcile loop exists; add an integration test that exercises AT-217 with real intent structures. Smallest increment: add a recovery pipeline stub that calls match_label and logs ambiguity; validate with a targeted unit/integration test.

## 3) Given what I built and the pain I hit (top sinks + failure modes), what 1-3 enforceable AGENTS.md rules should we add so the next agent doesn't repeat it?
- Response: None proposed.
