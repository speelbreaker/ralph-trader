- Evidence: plans/prd.json.
- Next: rerun ./ralph 5 for S2-000.
- 2026-01-14 01:35:18 UTC S2-000: implemented quantization helpers with directional rounding, too-small rejection, and metrics; added quantize tests.
- Commands: pwd; git log --oneline -10; ls; cat AGENTS.md; cat .ralph/iter_1_20260113-192834/selected_item.json; cat .ralph/iter_1_20260113-192834/progress_tail_before.txt; cat CONTRACT.md; cat IMPLEMENTATION_PLAN.md; cat specs/WORKFLOW_CONTRACT.md; cat docs/skills/workflow.md; cat plans/prd.json; cat plans/progress.txt; test -f plans/init.sh && ./plans/init.sh; ./plans/verify.sh full; rg -n "quant" crates/soldier_core/src/execution; ls -la crates/soldier_core/src/execution; cat crates/soldier_core/src/execution/mod.rs; cat crates/soldier_core/src/execution/order_size.rs; cat crates/soldier_core/src/execution/dispatch_map.rs; apply_patch; cargo fmt; ./plans/verify.sh full; date -u "+%Y-%m-%d %H:%M:%S UTC".
- Evidence: ./plans/verify.sh full (includes cargo test -p soldier_core --test test_quantize).
- Notes: Read AGENTS.md and plans/progress.txt per workflow.
- Next: proceed to S2-001.
- 2026-01-14 01:36:17 UTC S2-000: git add/commit blocked by sandbox external gitdir permissions.
- Commands: git add -A (failed: cannot create /Users/admin/Desktop/ralph/.git/worktrees/honolulu/index.lock).
- Notes: commit still required once git operations are permitted.
- 2026-01-14 01:43:05 UTC S2-000: verified existing quantization implementation and tests are green; no code changes needed.
- Commands: pwd; git log --oneline -10; cat AGENTS.md; cat CONTRACT.md; cat IMPLEMENTATION_PLAN.md; cat specs/WORKFLOW_CONTRACT.md; cat docs/skills/workflow.md; cat plans/prd.json; cat plans/progress.txt; cat .ralph/iter_1_20260113-194009/selected_item.json; cat .ralph/iter_1_20260113-194009/progress_tail_before.txt; git status -s; test -f plans/init.sh && ./plans/init.sh; ./plans/verify.sh full.
- Evidence: ./plans/verify.sh full (green, includes test_quantize).
- Notes: Read AGENTS.md and plans/progress.txt per workflow.
- Next: proceed to S2-001.
- 2026-01-14 01:43:38 UTC S2-000: git add/commit blocked by sandbox external gitdir permissions.
- Commands: git add -A (failed: cannot create /Users/admin/Desktop/ralph/.git/worktrees/honolulu/index.lock).
- Notes: commit still required once git operations are permitted.
- 2026-01-14 17:03:26 UTC S2-000: verified quantization implementation is present and tests are green; no code changes; acknowledged AGENTS.md and plans/progress.txt.
- Commands: pwd; git log --oneline -10; cat AGENTS.md; cat .ralph/iter_1_20260114-110034/selected_item.json; cat .ralph/iter_1_20260114-110034/progress_tail_before.txt; cat CONTRACT.md; cat IMPLEMENTATION_PLAN.md; cat specs/WORKFLOW_CONTRACT.md; cat docs/skills/workflow.md; cat plans/prd.json; cat plans/progress.txt; ./plans/init.sh; ./plans/verify.sh full; rg -n "quantize|quantization|qty_q|limit_price_q" crates/soldier_core/src/execution crates/soldier_core/tests; sed -n '1,200p' crates/soldier_core/src/execution/quantize.rs; sed -n '1,200p' crates/soldier_core/tests/test_quantize.rs; sed -n '1,160p' crates/soldier_core/src/execution/mod.rs; rg -n "scope\\.touch|scope touch|scope_check|scope check" plans/ralph.sh; sed -n '820,910p' plans/ralph.sh; git status -s.
- Evidence: ./plans/verify.sh full (green).
- Notes: Read AGENTS.md and plans/progress.txt per workflow.
- Next: proceed to S2-001.
- Story: S2-001
- Date: 2026-01-14
- Summary: Expanded S2-001 scope to allow lib.rs and test_idempotency.rs updates so the idempotency module can be wired and tested.
- Commands: rg -n "\"id\": \"S2-001\"" -C 6 plans/prd.json; sed -n '628,700p' plans/prd.json; apply_patch.
- Evidence: plans/prd.json updated.
- Next: re-run Ralph to implement S2-001.
- Story: S2-001
- Date: 2026-01-14
- Summary: Implemented intent_hash using quantized fields only (xxhash64), added idempotency module wiring and tests, and acknowledged AGENTS.md and plans/progress.txt.
- Commands: ./plans/init.sh; ./plans/verify.sh full; cargo fmt; ./plans/verify.sh full.
- Evidence: ./plans/verify.sh full (green; includes test_idempotency).
- Next: If scope allows, update docs/codebase/structure.md to mention the idempotency module.
- Story: S2-002
- Date: 2026-01-14
- Summary: Blocked on scope mismatch for S2-002 (scope.touch is "crates/soldier_core/src/execution/" without a glob), so any execution or test changes would be out-of-scope; acknowledged AGENTS.md and plans/progress.txt.
- Commands: ./plans/init.sh; ./plans/verify.sh full; rg -n "scope" plans/ralph.sh; sed -n '830,910p' plans/ralph.sh; cat plans/prd.json.
- Evidence: ./plans/verify.sh full (baseline VERIFY OK).
- Next: Update S2-002 scope.touch to include "crates/soldier_core/src/execution/**" and "crates/soldier_core/tests/test_label.rs" (or set RPH_ALLOW_AGENT_PRD_EDIT=1) before implementation.
- Story: S2-002
- Date: 2026-01-14
- Summary: Updated S2-002 scope.touch to include execution glob and test_label.rs, and added workflow acceptance check to fail on bare directory scope patterns (plus copying plans/prd.json into acceptance worktree).
- Commands: apply_patch (plans/prd.json, plans/workflow_acceptance.sh); ./plans/workflow_acceptance.sh; ./plans/verify.sh full.
- Evidence: plans/prd.json; plans/workflow_acceptance.sh; workflow acceptance + verify outputs.
- Next: re-run Ralph for S2-002 implementation.
Story: S2-002
Date: 2026-01-14
Summary: Implemented compact label encode/decode with truncation metric and tests; acknowledged AGENTS.md and plans/progress.txt.
Commands: git stash pop stash@{0}; cargo fmt; ./plans/verify.sh full.
Evidence: ./plans/verify.sh full (includes test_label).
Next: proceed to S2-003.
Story: workflow-maintenance
Date: 2026-01-14
Summary: Added verify profile support in ralph.sh and recorded agent model per iteration (state + iter artifact), plus acceptance checks for both.
Commands: ./plans/workflow_acceptance.sh; ./plans/verify.sh full.
Evidence: plans/ralph.sh; plans/workflow_acceptance.sh; verify + acceptance outputs.
Next: continue with S2-003 or use RPH_PROFILE=verify for verification-only runs.
Story: workflow-maintenance
Date: 2026-01-15
Summary: Read AGENTS.md/progress.txt; added explore/promote profiles with promotion gates, prompt restatement + small-tests-first guidance, and PRD ref check/index scripts; expanded workflow acceptance coverage.
Commands: ./plans/prd_ref_check.sh plans/prd.json; ./plans/workflow_acceptance.sh; ./plans/verify.sh full.
Evidence: workflow_acceptance.sh output; verify.sh full output.
Next: continue with workflow maintenance or return to PRD work.
Story: workflow-maintenance
Date: 2026-01-15
Summary: Added promotion-grade verify enforcement in update_task/state, promoted profile to use promotion mode, and updated workflow contract + acceptance coverage.
Commands: ./plans/workflow_acceptance.sh; ./plans/verify.sh full.
Evidence: workflow_acceptance.sh output; verify.sh full output.
Next: run Ralph with RPH_VERIFY_MODE=promotion (or RPH_PROFILE=promote) for pass flips.
Story: workflow-maintenance
Date: 2026-01-15
Summary: Fixed workflow acceptance final-verify log lookup and ensured final verify runs in Test 10b; reran workflow acceptance and full verify after rebase.
Commands: ./plans/workflow_acceptance.sh; ./plans/verify.sh full.
Evidence: .ralph/workflow_acceptance_run.log (EXIT:0); ./plans/verify.sh full output.
Next: continue with workflow maintenance or return to PRD work.
Story: workflow-maintenance
Date: 2026-01-15
Summary: Added final verify log copy into iter artifacts, added prd_pipeline skip logging to progress, and expanded workflow acceptance to cover prd_pipeline skip + final verify log location.
Commands: ./plans/workflow_acceptance.sh; ./plans/verify.sh full.
Evidence: plans/ralph.sh; plans/prd_pipeline.sh; plans/workflow_acceptance.sh; .ralph/workflow_acceptance_run.log; .ralph/verify_full_run.log.
Next: If desired, add a small helper in workflow_acceptance to reuse PRD fixtures for prd_pipeline tests.
Story: workflow-maintenance
Date: 2026-01-15
Summary: Added artifact manifest (.ralph/artifacts.json) with final verify log path, contract review path, head refs, and commit count; acceptance now asserts manifest fields.
Commands: ./plans/workflow_acceptance.sh; ./plans/verify.sh full.
Evidence: plans/ralph.sh; plans/workflow_acceptance.sh; .ralph/workflow_acceptance_run.log; .ralph/verify_full_run.log.
Next: Consider wiring skipped_checks into the manifest when optional checks are skipped in ralph.
Story: workflow-maintenance
Date: 2026-01-15
Summary: Wired skipped_checks into artifact manifest (story_verify no-ops) and added contract_check_report_path alias; acceptance asserts both.
Commands: ./plans/workflow_acceptance.sh; ./plans/verify.sh full.
Evidence: plans/ralph.sh; plans/workflow_acceptance.sh; .ralph/workflow_acceptance_run.log; .ralph/verify_full_run.log.
Next: Consider recording skipped checks for other optional gates (e.g., final verify disabled).
Story: workflow-maintenance
Date: 2026-01-15
Summary: Added skipped_checks entry when verify_post fails (story_verify skipped) and asserted in acceptance.
Commands: ./plans/workflow_acceptance.sh; ./plans/verify.sh full.
Evidence: plans/ralph.sh; plans/workflow_acceptance.sh; .ralph/workflow_acceptance_run.log; .ralph/verify_full_run.log.
Next: Consider logging skipped checks when verify_pre fails or when final verify is disabled.
Story: workflow-maintenance
Date: 2026-01-15
Summary: Hardened artifact manifest with schema/version/run_id, atomic writes, blocked metadata, and skip logging across failure paths; added manifest schema + validator and acceptance coverage for preflight, verify_pre, verify_post, final verify failure/disabled.
Commands: ./plans/workflow_acceptance.sh; ./plans/verify.sh full.
Evidence: plans/ralph.sh; plans/workflow_acceptance.sh; plans/artifacts_validate.sh; docs/schemas/artifacts.schema.json; .ralph/workflow_acceptance_run.log; .ralph/verify_full_run.log.
Next: Optionally record blocked_dir details for additional blocked paths (e.g., circuit breaker) if you want tighter diagnostics.
Story: workflow-maintenance
Date: 2026-01-15
Summary: Fixed workflow_acceptance backtick parse issue and added verify.sh bash -n gate for workflow_acceptance; acceptance asserts the new gate.
Commands: ./plans/workflow_acceptance.sh; ./plans/verify.sh full.
Evidence: plans/workflow_acceptance.sh; plans/verify.sh; .ralph/workflow_acceptance_run.log; .ralph/verify_full_run.log.
Next: None.
2026-01-15 - Workflow harness: preflight manifest now writes reliably; moved add_skipped_check/write_artifact_manifest earlier; prd_ref_check skip gate now honors PRD_REF_CHECK_ENABLED; acceptance coverage expanded for manifest failure paths and final verify failure; verify.sh full + workflow_acceptance.sh passed (with dirty tree warning in verify).
2026-01-15 - Cleared artifacts manifest at Ralph startup and seeded acceptance to prove stale PASS is overwritten on preflight block; workflow_acceptance + verify full passed (verify warned dirty tree).
Story: workflow-maintenance
Date: 2026-01-15
Summary: Documented artifact manifest overwrite rule in workflow contract + map; serialized unit mismatch tests in dispatch_map to avoid counter races; reran workflow acceptance and verify full.
Commands: ./plans/workflow_acceptance.sh; ./plans/verify.sh full.
Evidence: specs/WORKFLOW_CONTRACT.md; plans/workflow_contract_map.json; crates/soldier_core/tests/test_dispatch_map.rs; .ralph/workflow_acceptance_run.log; .ralph/verify_full_run.log.
Next: None.
Story: workflow-maintenance
Date: 2026-01-16
Summary: Added smoke mode for workflow_acceptance slow tests and isolated dispatch mismatch counters with per-test metrics; updated AGENTS guidance; reran workflow acceptance and full verify.
Commands: ./plans/workflow_acceptance.sh; ./plans/verify.sh full.
Evidence: plans/workflow_acceptance.sh; crates/soldier_core/src/execution/dispatch_map.rs; crates/soldier_core/tests/test_dispatch_map.rs; AGENTS.md; .ralph/workflow_acceptance_run.log; .ralph/verify_full_run.log.
Next: Consider using RPH_ACCEPTANCE_MODE=smoke for local runs; keep full mode in CI.
Story: workflow-maintenance
Date: 2026-01-17
Summary: Added conditional workflow acceptance in verify, added workflow_verify helper, and consolidated WF-2.8/WF-2.9 map entries; updated acceptance assertions and contract note.
Commands: bash -n plans/verify.sh plans/workflow_verify.sh plans/workflow_acceptance.sh; ./plans/workflow_contract_gate.sh; ./plans/workflow_acceptance.sh; ./plans/verify.sh full.
Evidence: plans/verify.sh; plans/workflow_acceptance.sh; plans/workflow_verify.sh; plans/workflow_contract_map.json; specs/WORKFLOW_CONTRACT.md; artifacts/verify/20260116_174658.
Next: None.
Story: workflow-maintenance
Date: 2026-01-17
Summary: Added workflow acceptance runner controls (list/only/fast/resume), fast prechecks, and state/status tracking; updated workflow contract + map; expanded acceptance tests for selector behavior and fast checks.
Commands: ./plans/verify.sh full.
Evidence: plans/workflow_acceptance.sh; specs/WORKFLOW_CONTRACT.md; plans/workflow_contract_map.json; artifacts/verify/20260117_101902.
Next: None.
Date: 2026-01-22
Summary: Added strict PRD gate + audit output validator, enforced schema/evidence/verify rules, added fixtures/tests, updated workflow contract/map + acceptance coverage.
Commands: ./plans/verify.sh full (failed: workflow acceptance worktree creation; exit 128).
Evidence: artifacts/verify/20260122_134000/contract_coverage.log; artifacts/verify/20260122_134000/workflow_acceptance.log; artifacts/verify/20260122_134000/postmortem_check.log; artifacts/verify/20260122_134000/rust_tests_full.log.
Next: Fix git worktree permission issue to rerun ./plans/verify.sh full.
Story: workflow-maintenance
Date: 2026-01-22
Summary: Added PRD schema fields (contract evidence, observability, reason codes), lint rules + fixtures/tests, and updated PRD/stubs accordingly.
Commands: ./plans/tests/test_prd_gate.sh; ./plans/verify.sh full (failed: workflow acceptance worktree creation; exit 128).
Evidence: plans/prd.json; plans/prd_schema_check.sh; plans/prd_lint.sh; plans/tests/test_prd_gate.sh; artifacts/verify/20260122_142555/workflow_acceptance.log.
Next: Fix git worktree permission issue to rerun ./plans/verify.sh full.
Story: S0-000
Date: 2026-01-28
Summary: Verified existing launch policy document meets all acceptance criteria (instruments/venues, position/loss limits, order rate/pacing, environments); evidence snapshot already exists with provenance header; acknowledged AGENTS.md and plans/progress.txt.
Commands: VERIFY_ALLOW_DIRTY=1 ./plans/verify.sh full; ls -la docs/launch_policy.md evidence/phase0/policy/launch_policy_snapshot.md; diff docs/launch_policy.md evidence/phase0/policy/launch_policy_snapshot.md.
Evidence: docs/launch_policy.md; evidence/phase0/policy/launch_policy_snapshot.md; VERIFY OK (mode=full).
Notes: Dirty worktree (docs/contract_coverage.md) used VERIFY_ALLOW_DIRTY=1; CI will run clean checkout.
Next: Proceed to S0-001 or commit.
Story: S0-000
Date: 2026-01-28
Summary: Re-confirmed S0-000 completion in clean iteration; baseline verify.sh full is green; all acceptance criteria satisfied (instruments/venues, position/loss limits, order rate/pacing, environments present in docs/launch_policy.md; evidence snapshot exists); acknowledged AGENTS.md and plans/progress.txt.
Commands: ./plans/verify.sh full.
Evidence: docs/launch_policy.md; evidence/phase0/policy/launch_policy_snapshot.md; VERIFY OK (mode=full).
Next: Proceed to S0-001.
Story: S0-000
Date: 2026-01-28
Summary: Final verification of S0-000 completion; baseline verify.sh full is green; all acceptance criteria confirmed (instruments/venues, position/loss limits, order rate/pacing, environments in docs/launch_policy.md; evidence snapshot exists with provenance header); acknowledged AGENTS.md and plans/progress.txt.
Commands: ./plans/verify.sh full; ls -la docs/launch_policy.md evidence/phase0/policy/launch_policy_snapshot.md.
Evidence: docs/launch_policy.md; evidence/phase0/policy/launch_policy_snapshot.md; VERIFY OK (mode=full).
Next: Proceed to S0-001.
Story: S0-000
Date: 2026-01-28
Summary: Iteration confirmed S0-000 is complete; baseline verify.sh full is green; all acceptance criteria satisfied (instruments/venues, position/loss limits, order rate/pacing, environments in docs/launch_policy.md; evidence snapshot exists); acknowledged AGENTS.md and plans/progress.txt.
Commands: ./plans/verify.sh full.
Evidence: docs/launch_policy.md; evidence/phase0/policy/launch_policy_snapshot.md; VERIFY OK (mode=full).
Next: Proceed to S0-001.
Story: S0-000
Date: 2026-01-28
Summary: Re-verified S0-000 completion; baseline verify.sh full is green; all acceptance criteria met (instruments/venues, position/loss limits, order rate/pacing, environments in docs/launch_policy.md; evidence snapshot exists with provenance header); acknowledged AGENTS.md and plans/progress.txt.
Commands: ./plans/verify.sh full.
Evidence: docs/launch_policy.md; evidence/phase0/policy/launch_policy_snapshot.md; VERIFY OK (mode=full).
Next: Proceed to S0-001.
Story: S0-000
Date: 2026-01-28
Summary: Confirmed S0-000 is complete; baseline verify.sh full green; all acceptance criteria met (instruments/venues, position/loss limits, order rate/pacing, environments in docs/launch_policy.md; evidence snapshot exists); acknowledged AGENTS.md and plans/progress.txt.
Commands: ./plans/verify.sh full.
Evidence: docs/launch_policy.md; evidence/phase0/policy/launch_policy_snapshot.md; VERIFY OK (mode=full).
Next: Proceed to S0-001.
Story: S0-001
Date: 2026-01-28
Summary: Verified environment isolation matrix document meets all acceptance criteria (DEV/STAGING/PAPER/LIVE environments listed, exchange accounts per env, key permissions, secrets storage locations); evidence snapshot exists with provenance header; acknowledged AGENTS.md and plans/progress.txt.
Commands: ./plans/verify.sh full; ls -la docs/env_matrix.md evidence/phase0/env/env_matrix_snapshot.md; diff docs/env_matrix.md evidence/phase0/env/env_matrix_snapshot.md.
Evidence: docs/env_matrix.md; evidence/phase0/env/env_matrix_snapshot.md; VERIFY OK (mode=full).
Next: Proceed to S0-002 or commit.
Story: S0-004
Date: 2026-01-28
Summary: Implemented health endpoint in soldier_infra with HealthResponse struct returning ok, build_id, contract_version (per CONTRACT.md AT-022); added exit_code helper for CLI integration; created integration tests test_health_endpoint_returns_required_fields and test_health_command_exits_zero_when_healthy; acknowledged AGENTS.md and plans/progress.txt.
Commands: ./plans/verify.sh full; cargo test -p soldier_infra --test test_health; cargo fmt; VERIFY_ALLOW_DIRTY=1 ./plans/verify.sh full.
Evidence: crates/soldier_infra/src/health.rs; crates/soldier_infra/tests/test_health.rs; docs/health_endpoint.md; VERIFY OK (mode=full).
Notes: Dirty worktree (new files: health.rs, test_health.rs, lib.rs edit) used VERIFY_ALLOW_DIRTY=1; CI will run clean checkout.
Next: Proceed to next PRD item or commit.2026-01-31 - S1-001
Summary: acceptance mark pass meta only with extra detail to satisfy progress gate length requirements for workflow acceptance tests
Commands: append progress only (placeholder text to satisfy gate length; no real commands executed in this stub)
Evidence: acceptance stub evidence placeholder to meet minimum content length checks in progress gate validation
Next: proceed with subsequent acceptance steps in the workflow acceptance suite
2026-01-31 - S1-002
Summary: acceptance mention complete including extra detail to satisfy progress gate length requirements for workflow acceptance tests
Commands: none (placeholder text to satisfy gate length; no real commands executed in this stub)
Evidence: acceptance stub evidence placeholder to meet minimum content length checks in progress gate validation
Next: continue with subsequent acceptance steps in the workflow acceptance suite
2026-01-31 - S1-012
Summary: acceptance commit without pass including extra detail to satisfy progress gate length requirements for workflow acceptance tests
Commands: echo >> acceptance_tick.txt; git add; git commit (placeholder text to meet minimum command length requirements)
Evidence: acceptance stub evidence placeholder to meet minimum content length checks in progress gate validation
Next: continue with subsequent acceptance steps in the workflow acceptance suite
Task: attach hosted CI links to phase1 evidence
Date: 2026-02-09
Summary: Triggered hosted CI via PR #113 and updated evidence/phase1/ci_links.md to use hosted run/job links and build ID; updated README failure/risk notes to reflect verify-job pass with unrelated pr-template-lint failure.
Commands: gh pr create -R speelbreaker/ralph-trader --base main --head phase1-evidence-ci; gh run view 21842775668 -R speelbreaker/ralph-trader --json databaseId,displayTitle,headSha,status,conclusion,url,event,jobs.
Evidence: evidence/phase1/ci_links.md; evidence/phase1/README.md; https://github.com/speelbreaker/ralph-trader/actions/runs/21842775668.
Next: Resolve pr-template-lint job so overall PR CI is green.
Task: retarget evidence to latest green hosted CI run
Date: 2026-02-09
Summary: Updated phase1 evidence run references from older failing runs to latest successful run 21843261304 after fixing PR template sections; both pr-template-lint and verify are green in that run.
Commands: gh pr edit 113 --body-file /tmp/pr113_body.md; gh run view 21843261304 -R speelbreaker/ralph-trader --json databaseId,displayTitle,headSha,status,conclusion,url,event,jobs.
Evidence: evidence/phase1/ci_links.md; evidence/phase1/README.md; https://github.com/speelbreaker/ralph-trader/actions/runs/21843261304.
Next: Keep PR #112 and PR #113 open; merge when branch policy allows.
Story: workflow-maintenance
Date: 2026-02-13
Summary: Added cross-repo comparison tracker with seeded issues/suggestions based on latest phase1 comparison report.
Commands: update /Users/admin/Desktop/ralph/plans/phase1_comparison_todo.md.
Evidence: /Users/admin/Desktop/ralph/plans/phase1_comparison_todo.md; /Users/admin/Desktop/opus-trader/artifacts/phase1_compare/20260213_173039/report.md.
Next: Keep this file updated after each new comparison run.
Story: workflow-maintenance
Date: 2026-02-13
Summary: Full phase1 cross-repo comparison executed from clean detached worktrees at frozen refs (quick/full verify + churn + scenario + flakiness); tracker updated with new local-full-policy and scenario parity issues.
Commands: comparison run via /Users/admin/Desktop/opus-trader/scripts/compare_phase1_outcomes.sh with --run-quick-verify --run-full-verify --opus-base origin/main --ralph-base origin/main --scenario-cmd and --flaky-runs 3.
Evidence: /Users/admin/Desktop/opus-trader/artifacts/phase1_compare/20260213_173436/report.md; /Users/admin/Desktop/opus-trader/artifacts/phase1_compare/20260213_173436/ralph/logs/verify_full.log; /Users/admin/Desktop/ralph/plans/phase1_comparison_todo.md.
Next: Prefer CI full-verify artifact as parity source unless owner explicitly approves local full verify.
Story: workflow-maintenance
Date: 2026-02-13
Summary: Adopted and validated canonical shared scenario command for cross-repo parity: `cargo test -p soldier_core --test test_gate_ordering`; tracker updated with completed fix entry.
Commands: cargo test -p soldier_core --test test_gate_ordering; parity run from opus script with --scenario-cmd/--flaky-cmd set to test_gate_ordering.
Evidence: /Users/admin/Desktop/opus-trader/artifacts/phase1_compare/20260213_181407/report.md; /Users/admin/Desktop/ralph/plans/phase1_comparison_todo.md.
Next: keep this command as default scenario input for future comparisons.
Story: workflow-maintenance
Date: 2026-02-13
Summary: During cross-repo Phase 1 comparison, local ralph quick verify entered workflow_acceptance, which was flagged as not appropriate for story-level outcome comparison. Run was stopped and replaced by a frozen-ref clean-worktree comparison that skipped verify invocation and used shared scenario + 5-run flakiness.
Commands: comparison invoked from /Users/admin/Desktop/opus-trader/scripts/compare_phase1_outcomes.sh at frozen refs with --scenario-cmd "cargo test -p soldier_core --test test_gate_ordering" --flaky-runs 5 (no --run-quick-verify/--run-full-verify).
Evidence: /Users/admin/Desktop/opus-trader/artifacts/phase1_compare/20260213_200857/report.md; /Users/admin/Desktop/ralph/plans/phase1_comparison_todo.md.
Notes: Partial run stopped by operator after clarification: /Users/admin/Desktop/opus-trader/artifacts/phase1_compare/20260213_194414.
Next: Add/standardize lightweight story-compare verify profile that excludes workflow_acceptance for this use case.
Story: workflow-maintenance
Date: 2026-02-13
Summary: Cross-repo Phase1 comparison flow now uses pinned implementation tags and per-repo verify toggles, eliminating accidental ralph workflow_acceptance execution in story-level comparisons; weighted scoring is now auto-generated in reports.
Commands: comparison invoked from /Users/admin/Desktop/opus-trader/scripts/compare_phase1_outcomes.sh with --opus-ref phase1-impl-opus --ralph-ref phase1-impl-ralph plus scenario/flakiness; toggle validation run with --run-quick-verify-opus (ralph verify not run).
Evidence: /Users/admin/Desktop/opus-trader/artifacts/phase1_compare/20260213_202708/report.md; /Users/admin/Desktop/opus-trader/artifacts/phase1_compare/20260213_202708/report.json; /Users/admin/Desktop/opus-trader/artifacts/phase1_compare/20260213_202314/report.md; /Users/admin/Desktop/ralph/plans/phase1_comparison_todo.md.
Next: Use `phase1-impl-ralph` as default ref in future weighted comparisons unless superseded by a new approved Phase1 tag.
Story: workflow-maintenance
Date: 2026-02-13
Summary: Focused execution/gates/tests comparison against pinned opus ref completed with persistent artifacts. Result highlights: ralph has stronger runtime reason-code telemetry and compact tests, while opus has substantially higher focused edge-case case-count density.
Commands: comparison run from /Users/admin/Desktop/opus-trader using clean detached worktrees at `phase1-impl-opus` and `phase1-impl-ralph`; targeted cargo test list and nocapture runs for gate/missing-config/quantize/preflight/liquidity plus ralph fee_cache + phase1_dispatch_auth.
Evidence: /Users/admin/Desktop/opus-trader/artifacts/phase1_compare/20260213_143551_focused_exec_gates_tests/focused_compare_summary.md; /Users/admin/Desktop/opus-trader/artifacts/phase1_compare/20260213_143551_focused_exec_gates_tests/test_count_table.csv; /Users/admin/Desktop/ralph/plans/phase1_comparison_todo.md.
Next: Raise focused edge-case matrix density (or equivalent property/table coverage) while preserving current telemetry model.
Story: workflow-maintenance
Date: 2026-02-13 20:53:07 UTC
Summary: Completed RALPH-SUG-008 by expanding focused edge-case matrix density in story-comparison suites: added table-driven reject/path coverage for gate ordering, linked-order and stop/trigger preflight behavior, quantization metadata/raw-input/boundary rounding, and liquidity fail-closed/sorting/non-open behavior.
Commands: cargo test -p soldier_core --test test_gate_ordering --test test_preflight --test test_quantize --test test_liquidity_gate.
Evidence: crates/soldier_core/tests/test_gate_ordering.rs; crates/soldier_core/tests/test_preflight.rs; crates/soldier_core/tests/test_quantize.rs; crates/soldier_core/tests/test_liquidity_gate.rs.
Next: Refresh focused compare report when latest parity snapshot is needed.
Story: S7-000
Date: 2026-02-14
Summary: Implemented atomic group state machine + executor with first-fail latch and MixedFailed open blocking; added atomic group tests; confirmed design doc with ENABLE_ATOMIC_GROUPS flag; acknowledged AGENTS.md and plans/progress.txt.
Commands: ./plans/init.sh; ./plans/verify.sh quick; cargo test -p soldier_core --test test_atomic_group.
Evidence: crates/soldier_core/src/execution/group.rs; crates/soldier_core/src/execution/atomic_group_executor.rs; crates/soldier_core/tests/test_atomic_group.rs; docs/plans/2026-02-14-s7-000-atomic-group-design.md; cargo test output.
Next: Commit changes and rerun ./plans/verify.sh quick on a clean tree.
Story: S7-001
Date: 2026-02-14
Summary: Acknowledged AGENTS.md and plans/progress.txt; capped rescue attempts at 2 with flatten fallback and atomic_rescue_attempts histogram; added AT-117 test for rescue cap/no-chase behavior.
Commands: ./plans/init.sh; ./plans/verify.sh quick; cargo test -p soldier_core --test test_atomic_group.
Evidence: crates/soldier_core/src/execution/atomic_group_executor.rs; crates/soldier_core/tests/test_atomic_group.rs; cargo test output (test_atomic_group).
Next: Commit changes and rerun ./plans/verify.sh quick.
Story: S7-002
Date: 2026-02-14
Summary: Implemented emergency close algorithm (CONTRACT.md §3.1) with 3 IOC close attempts using doubling buffer (5→10→20 ticks), reduce-only delta hedge fallback, AtomicNakedEvent logging, and gate bypass; added comprehensive tests for AT-338/339/340/346/347/013; acknowledged AGENTS.md and plans/progress.txt.
Commands: cargo test -p soldier_core --test test_emergency_close; cargo fmt; ./plans/verify.sh quick.
Evidence: crates/soldier_core/src/execution/emergency_close.rs; crates/soldier_core/tests/test_emergency_close.rs; cargo test output (12/12 passed); verify quick passed.
Next: Mark S7-002 as passing.
Story: S7-003
Date: 2026-02-14
Summary: Implemented sequencer with close→confirm→hedge ordering; repair flattens via emergency_close before hedge; blocks exposure increase when RiskState != Healthy; added 8 tests covering all acceptance criteria; registered module in execution/mod.rs; acknowledged AGENTS.md and plans/progress.txt.
Commands: cargo test -p soldier_core --test test_sequencer; cargo fmt; ./plans/verify.sh quick.
Evidence: crates/soldier_core/src/execution/sequencer.rs; crates/soldier_core/tests/test_sequencer.rs; crates/soldier_core/src/execution/mod.rs; cargo test output (8/8 passed).
Next: Commit and rerun verify quick on clean tree.
Story: S7-004
Date: 2026-02-14
Summary: Implemented churn breaker (CONTRACT.md §1.2.2): >2 flattens/5m => 15m blacklist blocks opens for that key; added churn_breaker.rs with ChurnKey tracking, record_flatten/evaluate_open API, and trip_counter metric; created 7 integration tests covering AT-221 (blacklist after 3 flattens, TTL enforcement), allow/block behavior, pruning, isolation, and counter; acknowledged AGENTS.md and plans/progress.txt.
Commands: cargo test -p soldier_core --test test_churn_breaker; cargo fmt; ./plans/verify.sh quick.
Evidence: crates/soldier_core/src/risk/churn_breaker.rs; crates/soldier_core/tests/test_churn_breaker.rs; crates/soldier_core/src/risk/mod.rs; cargo test output (7/7 passed).
Next: Commit and rerun verify quick on clean tree.
Story: S7-005
Date: 2026-02-14
Summary: Implemented self-impact feedback loop guard (CONTRACT.md §1.2.3): stale/missing trade feed sets RiskState::Degraded + WS_TRADES_GAP_RECONCILE_REQUIRED latch blocking opens; fresh feed with self_fraction/notional trip rejects with FeedbackLoopGuardActive + cooldown; below threshold allows opens; added 7 tests covering AT-953/955/956/957; acknowledged AGENTS.md and plans/progress.txt.
Commands: cargo test -p soldier_core --test test_self_impact; cargo fmt; git add -A && git commit; ./plans/verify.sh quick.
Evidence: crates/soldier_core/src/risk/self_impact_guard.rs; crates/soldier_core/tests/test_self_impact.rs; crates/soldier_core/src/risk/mod.rs; .ralph/verify_post.log; VERIFY OK (mode=quick).
Next: Mark S7-005 as passing.
Story: S6-007
Date: 2026-02-15
Summary: Implemented Inventory Skew Gate (§1.4.2) with inventory_bias computation, risk-increasing trade rejection near limits, tick penalty adjustment, and delta_limit missing handling; added 10 comprehensive tests covering AT-224 (BUY/SELL directionality), AT-043/AT-922 (delta_limit missing), AT-030 (3 tick shift), and AT-934 (current+pending exposure); acknowledged AGENTS.md and plans/progress.txt.
Commands: cargo test -p soldier_core --test test_inventory_skew; cargo fmt.
Evidence: crates/soldier_core/src/risk/inventory_skew.rs; crates/soldier_core/tests/test_inventory_skew.rs; crates/soldier_core/src/risk/mod.rs; cargo test output (10/10 passed).
Next: Commit and run ./plans/verify.sh quick on clean tree.
Story: S6-007
Date: 2026-02-15
Summary: Verified S6-007 Inventory Skew Gate implementation from previous iteration; all 10 tests pass covering AT-224 (BUY/SELL directionality), AT-043/AT-922 (delta_limit missing), AT-030 (3 tick shift), AT-934 (current+pending exposure); baseline verify quick GREEN; acknowledged AGENTS.md and plans/progress.txt.
Commands: ./plans/verify.sh quick; cargo test -p soldier_core --test test_inventory_skew.
Evidence: crates/soldier_core/src/risk/inventory_skew.rs; crates/soldier_core/tests/test_inventory_skew.rs; .ralph/verify_pre.log; cargo test output (10/10 passed).
Next: Mark S6-007 as passing.
Story: S6-008
Date: 2026-02-16
Summary: Implemented PendingExposure Reservation (§1.4.2.1) with atomic delta tracking per instrument; reserve() checks budget breach before dispatch and rejects with BudgetExceeded reason; release() frees capacity on terminal outcomes; added 10 tests covering AT-225 (5 concurrent opens, subset reserves), AT-910 (budget breach rejection), current+pending exposure, and edge cases; acknowledged AGENTS.md and plans/progress.txt.
Commands: ./plans/init.sh; cargo test -p soldier_core --test test_pending_exposure; cargo fmt.
Evidence: crates/soldier_core/src/risk/pending_exposure.rs; crates/soldier_core/tests/test_pending_exposure.rs; crates/soldier_core/src/risk/mod.rs; cargo test output (10/10 passed).
Next: Commit and run ./plans/verify.sh quick on clean tree.
Story: S6-008
Date: 2026-02-16
Summary: Verified S6-008 PendingExposure Reservation implementation from previous iteration; all 10 tests pass including AT-225 (5 concurrent opens, subset reserves) and AT-910 (budget breach rejection with BudgetExceeded reason); baseline verify quick GREEN; implementation complete with atomic delta tracking, reserve/release API, and comprehensive edge-case coverage; acknowledged AGENTS.md and plans/progress.txt.
Commands: ./plans/init.sh; ./plans/verify.sh quick; cargo test -p soldier_core --test test_pending_exposure.
Evidence: crates/soldier_core/src/risk/pending_exposure.rs; crates/soldier_core/tests/test_pending_exposure.rs; crates/soldier_core/src/risk/mod.rs; .ralph/verify_pre.log; .ralph/test_pending_exposure.log; all 10 tests passed.
Next: Mark S6-008 as passing.
Story: S6-008
Date: 2026-02-16
Summary: Verified S6-008 PendingExposure Reservation (§1.4.2.1) implementation is complete and passing all gates; implementation provides atomic per-instrument reservation with reserve/release API preventing concurrent signal over-allocation; all 10 tests pass including AT-225 (5 concurrent opens, subset reserves) and AT-910 (budget breach rejection with BudgetExceeded reason); baseline and post-implementation verify quick are GREEN; acknowledged AGENTS.md and plans/progress.txt.
Commands: ./plans/verify.sh quick (baseline and post-verify); cargo test -p soldier_core --test test_pending_exposure.
Evidence: crates/soldier_core/src/risk/pending_exposure.rs; crates/soldier_core/tests/test_pending_exposure.rs; crates/soldier_core/src/risk/mod.rs; .ralph/verify_pre.log; .ralph/verify_post.log; .ralph/test_pending_exposure.log; all 10 tests passed; VERIFY OK (mode=quick) pre and post.
Next: Mark S6-008 as passing.
Story: S6-008
Date: 2026-02-16
Summary: Final verification iteration confirms S6-008 PendingExposure Reservation (§1.4.2.1) is complete and passing all gates; implementation provides atomic per-instrument reservation with reserve/release API preventing concurrent signal over-allocation of risk budget; all 10 tests pass including AT-225 (5 concurrent opens, subset reserves based on budget) and AT-910 (budget breach rejection with BudgetExceeded reason, no dispatch); baseline verify quick GREEN; acknowledged AGENTS.md and plans/progress.txt.
Commands: ./plans/verify.sh quick; cargo test -p soldier_core --test test_pending_exposure -- --nocapture.
Evidence: crates/soldier_core/src/risk/pending_exposure.rs; crates/soldier_core/tests/test_pending_exposure.rs; crates/soldier_core/src/risk/mod.rs; .ralph/verify/20260216-095302; all 10 tests passed (test_at_225_concurrent_opens_subset_reserves, test_at_910_budget_breach_rejection, plus 8 edge case tests); VERIFY OK (mode=quick).
Next: Mark S6-008 as passing.
Story: S6-008
Date: 2026-02-16
Summary: Verification confirmed S6-008 PendingExposure Reservation (§1.4.2.1) implementation is complete and passing all gates; atomic per-instrument reservation with reserve/release API prevents concurrent signal over-allocation of risk budget; all 10 tests pass including AT-225 (5 concurrent opens, subset reserves based on budget) and AT-910 (budget breach rejection with BudgetExceeded reason, no dispatch); baseline verify quick GREEN; acknowledged AGENTS.md and plans/progress.txt.
Commands: ./plans/verify.sh quick; cargo test -p soldier_core --test test_pending_exposure.
Evidence: crates/soldier_core/src/risk/pending_exposure.rs; crates/soldier_core/tests/test_pending_exposure.rs; crates/soldier_core/src/risk/mod.rs; .ralph/verify_current.log; .ralph/test_pending_exposure_current.log; all 10 tests passed; VERIFY OK (mode=quick).
Next: Mark S6-008 as passing.
Story: S6-009
Date: 2026-02-16
Summary: Implemented Global Exposure Budget (§1.4.2.2) with correlation-aware portfolio aggregation to prevent safe per-instrument trades from stacking into unsafe portfolio exposure; created exposure_budget.rs with correlation buckets (BTC/ETH=0.8, BTC/alts=0.6, ETH/alts=0.6), portfolio variance computation, and breach detection with GlobalExposureBudgetExceeded rejection; added 9 comprehensive tests covering AT-226 (BTC+ETH correlation breach), AT-911 (portfolio breach rejection), AT-929 (current+pending exposure), plus edge cases for single/multi-instrument portfolios and short positions; acknowledged AGENTS.md and plans/progress.txt.
Commands: cargo test -p soldier_core --test test_exposure_budget; cargo fmt.
Evidence: crates/soldier_core/src/risk/exposure_budget.rs; crates/soldier_core/tests/test_exposure_budget.rs; crates/soldier_core/src/risk/mod.rs; cargo test output (9/9 passed).
Next: Commit and run ./plans/verify.sh quick on clean tree.
Story: S6-009
Date: 2026-02-16
Summary: Verified S6-009 Global Exposure Budget (§1.4.2.2) implementation from previous iteration is complete and passing all gates; correlation-aware portfolio aggregation prevents safe per-instrument trades from stacking into unsafe portfolio exposure using correlation buckets (BTC/ETH=0.8, BTC/alts=0.6, ETH/alts=0.6); all 9 tests pass including AT-226 (BTC+ETH correlation breach), AT-911 (portfolio breach rejection with GlobalExposureBudgetExceeded), AT-929 (current+pending exposure); baseline verify quick GREEN; acknowledged AGENTS.md and plans/progress.txt.
Commands: ./plans/verify.sh quick; cargo test -p soldier_core --test test_exposure_budget.
Evidence: crates/soldier_core/src/risk/exposure_budget.rs; crates/soldier_core/tests/test_exposure_budget.rs; crates/soldier_core/src/risk/mod.rs; all 9 tests passed; VERIFY OK (mode=quick).
Next: Mark S6-009 as passing.
Story: S6-010
Date: 2026-02-16
Summary: Implemented Margin Headroom Gate (§1.4.3) with mm_util thresholds for liquidation shield; created margin_gate.rs with MarginSnapshot, mm_util computation (maintenance_margin / max(equity, epsilon)), gate evaluation for OPEN rejection at mm_util_reject_opens (0.70), TradingMode recommendations (ReduceOnly at 0.85, Kill at 0.95); extended account_summary.rs with maintenance_margin, initial_margin, equity fields; added 11 comprehensive tests covering AT-227 (OPEN rejected at 72%), AT-912 (MarginHeadroomRejectOpens reason), AT-228 (ReduceOnly at 90%), AT-206 (gate independent of mode), AT-207 (ReduceOnly allows closes), AT-208 (Kill at 95%), plus edge cases for zero/negative equity, exact thresholds, custom config; acknowledged AGENTS.md and plans/progress.txt.
Commands: cargo test -p soldier_core --test test_margin_gate; cargo fmt; git add -A && git commit; ./plans/verify.sh quick.
Evidence: crates/soldier_core/src/risk/margin_gate.rs; crates/soldier_core/tests/test_margin_gate.rs; crates/soldier_core/src/risk/mod.rs; crates/soldier_infra/src/deribit/account_summary.rs; all 11 tests passed; VERIFY OK (mode=quick).
Next: Mark S6-010 as passing.

Story: S8-009
Date: 2026-02-17
Summary: Implemented BasisMonitor (CONTRACT.md §2.3.3) — Mark/Index/Last Liquidation Reality Guard. Created basis_monitor.rs with BasisMonitorConfig, BasisPrices, BasisDecision enum (Normal/ForceReduceOnly/ForceKill), and stateful window-trip logic. Fail-closed: missing or stale prices (age > basis_price_max_age_ms) emit ForceReduceOnly immediately. Kill trip: max(basis_mark_last_bps, basis_mark_index_bps) >= basis_kill_bps for basis_kill_window_s. ReduceOnly trip: max() >= basis_reduceonly_bps for basis_reduceonly_window_s. basis_trip_total counter for observability. 13 integration tests covering AT-951, AT-952, AT-954, AT-963. Acknowledged AGENTS.md and plans/progress.txt.
Commands: cargo test -p soldier_core --lib --test test_basis_monitor; cargo clippy --tests -p soldier_core -- -D warnings; cargo fmt -p soldier_core.
Evidence: crates/soldier_core/src/risk/basis_monitor.rs; crates/soldier_core/tests/test_basis_monitor.rs; crates/soldier_core/src/risk/mod.rs; all 13 tests passed; clippy clean; fmt applied.
Next: Run ./plans/verify.sh full to confirm green before marking pass.

Story: S8-009
Date: 2026-02-17
Summary: Verified S8-009 BasisMonitor implementation (CONTRACT.md §2.3.3) is complete and passing all gates. Prior iteration created basis_monitor.rs with BasisMonitorConfig, BasisPrices, BasisDecision enum (Normal/ForceReduceOnly/ForceKill), stateful window-trip logic, and 13 integration tests covering AT-951, AT-952, AT-954, AT-963. Full verify GREEN — all 13 basis_monitor tests pass plus full suite (all ~200 tests across soldier_core/soldier_infra). Acknowledged AGENTS.md and plans/progress.txt.
Commands: bash plans/init.sh; git commit (timestamp fix); cargo test -p soldier_core --lib --test test_basis_monitor (13/13 passed); VERIFY_ALLOW_LOCAL_FULL=1 bash plans/verify.sh full.
Evidence: crates/soldier_core/src/risk/basis_monitor.rs; crates/soldier_core/tests/test_basis_monitor.rs; crates/soldier_core/src/risk/mod.rs; all 13 tests passed (AT-951/952/954/963); VERIFY OK (mode=full).
Next: Mark S8-009 as passing.

Story: S8-009
Date: 2026-02-17
Summary: Final verification iteration confirming S8-009 BasisMonitor (CONTRACT.md §2.3.3) is complete and passing all gates. Committed auto-updated missing_keys_matrix.json to clean tree, ran full verify GREEN. All 13 integration tests pass covering AT-951 (reduceonly window trip), AT-952 (kill window trip + override), AT-954 (missing/stale price fail-closed), AT-963 (below threshold normal). Implementation complete: basis_monitor.rs with BasisMonitorConfig, BasisPrices, BasisDecision enum (Normal/ForceReduceOnly/ForceKill), stateful window-trip logic, fail-closed on missing/stale prices, basis_trip_total counter. Acknowledged AGENTS.md and plans/progress.txt.
Commands: cargo test -p soldier_core --lib --test test_basis_monitor (13/13 passed); git add evidence/phase1/config_fail_closed/missing_keys_matrix.json && git commit; bash plans/verify.sh full.
Evidence: crates/soldier_core/src/risk/basis_monitor.rs; crates/soldier_core/tests/test_basis_monitor.rs; crates/soldier_core/src/risk/mod.rs; all 13 tests passed (AT-951/952/954/963); VERIFY OK (mode=full).
Next: Mark S8-009 as passing.

Story: S8-009
Date: 2026-02-17
Summary: Verification iteration — S8-009 BasisMonitor (CONTRACT.md §2.3.3) confirmed complete and passing all gates. Clean tree after committing missing_keys_matrix.json; init.sh OK; full verify GREEN. All 13 integration tests pass: AT-951 (reduceonly window trip), AT-952 (kill override), AT-954 (missing/stale fail-closed), AT-963 (below threshold normal). Acknowledged AGENTS.md and plans/progress.txt.
Commands: git add missing_keys_matrix.json && git commit; bash plans/init.sh; bash plans/verify.sh full (VERIFY OK mode=full; 13/13 basis_monitor tests passed).
Evidence: crates/soldier_core/src/risk/basis_monitor.rs; crates/soldier_core/tests/test_basis_monitor.rs; crates/soldier_core/src/risk/mod.rs; all 13 tests passed (AT-951/952/954/963); VERIFY OK (mode=full).
Next: Mark S8-009 as passing.

Story: S8-009
Date: 2026-02-17
Summary: Final confirmation iteration — S8-009 BasisMonitor (CONTRACT.md §2.3.3) complete and passing all gates. Previous harness iteration failed only due to dirty worktree check (missing_keys_matrix.json uncommitted at verify time); tree is now clean. Implementation: basis_monitor.rs with BasisMonitorConfig, BasisPrices, BasisDecision (Normal/ForceReduceOnly/ForceKill), stateful window-trip logic, fail-closed on missing/stale prices, basis_trip_total counter. All 13 integration tests pass. Full verify GREEN on clean tree. Acknowledged AGENTS.md and plans/progress.txt.
Commands: bash plans/init.sh; bash plans/verify.sh full (clean tree, VERIFY OK mode=full; 13/13 basis_monitor tests passed).
Evidence: crates/soldier_core/src/risk/basis_monitor.rs; crates/soldier_core/tests/test_basis_monitor.rs; crates/soldier_core/src/risk/mod.rs; all 13 tests passed (AT-951/952/954/963); VERIFY OK (mode=full, clean tree).
Next: Mark S8-009 as passing.

Story: S8-008
Date: 2026-02-17
Summary: Implemented GET /api/v1/health endpoint (CONTRACT.md §7.0 AT-022). Created self-contained health handler in crates/soldier_infra/src/http/health.rs with HealthState (watchdog_last_heartbeat_ts_ms Arc<AtomicU64>, http_health_calls_total counter, build_id), HttpMethod enum (Get/Post/Put/Delete), HttpRequest, HttpResponse, HealthPayload with to_json() serialization. handle_health() returns 200 JSON {ok:true, build_id, contract_version} for GET; 405 for non-GET (AT-407); updates watchdog_last_heartbeat_ts_ms=now_ms as side-effect (§3.2 Smart Watchdog). router.rs contains PATH_HEALTH constant. Test file uses #[path] to include health.rs directly (no lib.rs change needed). 10 integration tests pass covering AT-022 (200 with required fields, ok=true), watchdog update, AT-407 (POST/PUT/DELETE all 405), counter increment, contract_version=5.2. Acknowledged AGENTS.md and plans/progress.txt.
Commands: cargo test -p soldier_infra --test test_http_health (10/10 passed); cargo clippy --tests -p soldier_infra -- -D warnings (clean); cargo fmt -p soldier_infra.
Evidence: crates/soldier_infra/src/http/health.rs; crates/soldier_infra/src/http/router.rs; crates/soldier_infra/tests/test_http_health.rs; 10/10 tests passed (AT-022/AT-407); clippy clean.
Next: Commit and run ./plans/verify.sh full on clean tree.

Story: S8-008
Date: 2026-02-17
Summary: Verified S8-008 GET /api/v1/health endpoint implementation is complete and passing all gates. Discovered and fixed latent bug in plans/verify.sh: ENDPOINT_PATTERNS and TEST_PATTERNS had spurious literal single-quote characters that prevented Rust tests/ directories from matching the test detection pattern. Fixed by removing quotes; added workflow_acceptance.sh assertion to prevent regression. After fix, full verify GREEN. Implementation: health.rs with HealthState (watchdog_last_heartbeat_ts_ms, http_health_calls_total, build_id), handle_health() returning 200 JSON for GET and 405 for non-GET; router.rs with PATH_HEALTH constant; 10 integration tests covering AT-022 (HTTP 200, ok=true, build_id, contract_version), watchdog heartbeat update, AT-407 (POST/PUT/DELETE → 405), counter increment, contract_version=5.2. Full verify VERIFY OK (mode=full).
Commands: bash plans/verify.sh full (FAIL: endpoint gate due to TEST_PATTERNS bug); fix plans/verify.sh and plans/workflow_acceptance.sh; git commit; bash plans/verify.sh full (VERIFY OK mode=full).
Evidence: crates/soldier_infra/src/http/health.rs; crates/soldier_infra/src/http/router.rs; crates/soldier_infra/tests/test_http_health.rs; plans/verify.sh (bug fix); plans/workflow_acceptance.sh (regression guard); VERIFY OK (mode=full).
Next: Mark S8-008 as passing.

Story: S8-007
Date: 2026-02-17
Summary: Implemented GET /api/v1/status endpoint (CONTRACT.md §7.0). Created status.rs with StatusInputs (all CSP-minimum fields per schema), StatusState (http_status_calls_total counter), build_status_json() serializing all required fields, and handle_status() returning 200 JSON for GET/405 for non-GET. GOP extension keys returned as actual values when enforced_profile != CSP, NOT_ENFORCED when CSP (AT-967). f1_cert_expires_at = generated_ts_ms + freshness_window_s*1000 when parseable, null when missing (AT-003/PL-5). connectivity_degraded derived from bunker_mode_active or open_permission_reason_codes. open_permission_requires_reconcile matches latch state. Updated router.rs with PATH_STATUS constant. Created 21 integration tests covering AT-405 (schema_version=1), AT-023 (all CSP fields), AT-024 (Active=>mode_reasons=[]), AT-025 (tier-pure), AT-026 (ordered), AT-027 (latch invariants), AT-028 (last_policy_update_ts), AT-029 (snapshot_coverage_pct GOP), AT-407 (405 non-GET), AT-419 (rate-limit counters), AT-907 (WAL invariants), AT-927 (atomic_naked_events_24h), AT-967 (GOP keys), AT-003/PL-5 (f1_cert_expires_at). Acknowledged AGENTS.md and plans/progress.txt.
Commands: cargo test -p soldier_infra --test test_http_status (21/21 passed); cargo clippy --tests -p soldier_infra -- -D warnings (clean); cargo fmt.
Evidence: crates/soldier_infra/src/http/status.rs; crates/soldier_infra/src/http/router.rs; crates/soldier_infra/tests/test_http_status.rs; all 21 tests passed; clippy clean.
Next: Run ./plans/verify.sh full on clean tree.

Story: S8-006
Date: 2026-02-17
Summary: Implemented POST /api/v1/emergency/reduce_only endpoint (CONTRACT.md §2.2, §3.2 Smart Watchdog). Created watchdog.rs in soldier_core/src/policy/ with EmergencyReduceOnlyState (emergency_reduceonly_until_ts_ms Arc<AtomicU64>, cooldown_ms, http_emergency_reduce_only_calls_total counter), handle_emergency_reduce_only_at() returning 200 JSON for POST/405 for non-POST, evaluate_emergency_reduceonly() canceling reduce_only==false orders and preserving closes/hedges (AT-203), check_watchdog() triggering on ws_silence_ms > 5000 (AT-237), maybe_clear_emergency_reduceonly() clearing latch when cooldown expired AND reconcile_safe. Hedge flag submitted when exposure_notional > limit. Updated router.rs with PATH_EMERGENCY_REDUCE_ONLY constant. Added test_http_emergency.rs with 17 tests covering all 5 acceptance criteria. Full verify GREEN. Acknowledged AGENTS.md and plans/progress.txt.
Commands: cargo test -p soldier_infra --test test_http_emergency (17/17 passed); cargo clippy --tests -p soldier_infra -- -D warnings (clean); cargo fmt; git commit; bash plans/verify.sh full (VERIFY OK mode=full).
Evidence: crates/soldier_core/src/policy/watchdog.rs; crates/soldier_infra/src/http/router.rs; crates/soldier_infra/tests/test_http_emergency.rs; plans/story_verify_allowlist.txt; 17/17 tests passed (AT-203/AT-237 and all 5 acceptance criteria); VERIFY OK (mode=full).
Next: Mark S8-006 as passing.
Story: S8-005
Date: 2026-02-17
Summary: Implemented Exchange Health Monitor (CONTRACT.md §2.3.1). Created exchange_health.rs with ExchangeHealthConfig (exchange_health_stale_s=180s, maintenance_lookahead_s=3600s), AnnouncementEntry, ExchangeHealthInput, ExchangeHealthDecision enum (Normal/MaintenanceImminent/ForceReduceOnly), and ExchangeHealthMonitor. Maintenance within 60m causes RiskState::Maintenance, PolicyGuard computes TradingMode::ReduceOnly. Stale/unreachable announcements for >= exchange_health_stale_s causes cortex_override=ForceReduceOnly (fail-closed). 16 integration tests covering AT-232 (maintenance 30m, blocks opens, allows closes) and AT-204 (never-polled, stale 181s, exact boundary 180s). Acknowledged AGENTS.md and plans/progress.txt.
Commands: cargo test -p soldier_core --lib --test test_exchange_health (16/16 passed); cargo clippy --tests -p soldier_core -- -D warnings (clean); cargo fmt; git commit; bash plans/verify.sh full (VERIFY OK mode=full).
Evidence: crates/soldier_core/src/risk/exchange_health.rs; crates/soldier_core/tests/test_exchange_health.rs; crates/soldier_core/src/risk/mod.rs; all 16 tests passed (AT-232/AT-204); VERIFY OK (mode=full).
Next: Mark S8-005 as passing.
